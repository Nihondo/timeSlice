# timeSlice

**In Development**

timeSlice は macOS Sonoma+ のメニューバーアプリです。最前面ウィンドウを定期キャプチャし、OCR でテキストを抽出、AI CLI を使って日報を自動生成します。OCRはローカルで実行され、外部サーバーへの送信は行いません。Dock には表示されず、操作はメニューバーから行います。

UI文言は `Localizable.strings` により多言語化されており、現在は日本語と英語に対応しています。

## クイックスタート

1. timeSlice をビルドして起動する（[ビルド方法](#ソースからビルド)を参照）。
2. 初回起動時に **画面収録権限** の許可ダイアログが表示されるので許可する。
3. メニューバーの timeSlice アイコンから **記録開始** を選択する。
4. 日報を生成したい場合は **日報を生成** を選択する（CLI 設定が必要）。

## メニューバー

メニューバーアイコンは記録状態に応じて変化します。

- 停止中: `record.circle`（白丸）/ タイトル「timeSlice」
- 記録中: `record.circle.fill`（赤丸）/ タイトル「timeSlice ●」

### メニュー項目

| 項目 | 説明 |
|------|------|
| **timeSlice 設定...** (⌘,) | 設定ウィンドウを開く |
| **記録開始** / **記録終了** | キャプチャの開始・停止を切り替え |
| **今すぐ記録** | 1回だけキャプチャを実行（`captureTrigger: "manual"` として保存）。完了時は結果とウィンドウタイトルを通知に表示 |
| **日報を生成** | 設定済みの AI CLI で日報を生成 |
| **終了** (⌘Q) | アプリを終了 |

## キャプチャの仕組み

1. 設定間隔（デフォルト 60 秒）ごとに最前面ウィンドウをキャプチャ
2. Vision Framework で OCR テキストを抽出
3. 直前の記録と重複する場合はスキップ（ハッシュベース重複排除）
4. JSON レコード + PNG 画像（任意）をローカルに保存（JSON には `captureTrigger` として `manual` / `scheduled` を記録）

## 日報生成

外部の AI CLI（`claude`、`gemini` など）にプロンプトを渡して日報を生成します。

- CLI は `data/` ディレクトリをカレントディレクトリとして実行される
- プロンプトで `./YYYY/MM/DD/*.json` の相対パスを参照指示し、CLI が直接ファイルを読む方式
- 既定プロンプトでは、`captureTrigger = manual` の記録を重要ログとして優先的に要約するよう指示される
- 生成された Markdown は `reports/YYYY/MM/DD/report.md` に保存される
- 同日に再生成した場合は、上書き前の内容をファイル更新時刻ベースの `report-YYYY-MM-DD-HHmmss.md` として同じディレクトリにバックアップ保存し、最新は常に `report.md` として更新される
- `-p` / `--prompt` が末尾引数の場合、プロンプト文字列を自動的に引数値として注入
- 定時自動生成を有効化すると、設定した時刻に同じ生成フローが毎日実行される
- 日報生成完了時に通知センターへ通知され、通知クリックで `open` コマンドにより保存済み `report.md` を開ける

## 設定ガイド

### 一般

1. **設定** を開く。
2. **画面収録** で権限状態を確認する。未許可の場合は「権限状態を更新」で再確認。
3. **キーボードショートカット** で「今すぐ記録」のショートカットを設定する。
   - ショートカット欄をクリック後、キー + 修飾キー（⌘ / ⌥ / ⇧ / ⌃）を押して確定
   - `Esc` で入力キャンセル、`Delete` でショートカット無効化
   - アプリ起動中は他アプリを操作中でもグローバルに実行可能
4. **起動** セクションで以下を設定する。
   - **アプリ起動と同時に記録を開始**: ON にするとアプリ起動時に自動で記録開始
   - **ログイン時起動**: macOS ログイン時にアプリを自動起動（`SMAppService` 連携）

### キャプチャ

1. **キャプチャ** タブを開く。
2. **キャプチャ間隔** をスライダーで調整（10〜600 秒、デフォルト 60 秒）。
3. **最小テキスト長** を設定（デフォルト 10 文字）。この文字数以下の短文は記録されない。
4. **画像も保存する** トグルで PNG 保存の有無を切り替え。

### CLI

1. **CLI** タブを開く。
2. **CLI コマンド名** に AI CLI のコマンドを入力（例: `claude`、`gemini`）。
3. **追加引数** を設定（例: `-p`）。
4. **タイムアウト** を調整（30〜3600 秒、デフォルト 300 秒）。

### 日報

1. **日報** タブを開く。
2. **生成対象日オフセット** で対象日を調整（0 = 今日、-1 = 昨日、最大 -7）。
3. **定時自動生成** を有効化し、時刻を設定（時・分）。
4. **プロンプトテンプレート** を編集。使用可能なプレースホルダ:
   - `{{DATE}}` — 対象日（例: 2026年02月16日(月)）
   - `{{JSON_GLOB_PATH}}` — JSON ファイルの相対 glob パス
   - `{{RECORD_COUNT}}` — 対象日のレコード数
5. 「デフォルトに戻す」で既定テンプレートにリセット可能。
6. **日報保存先** で保存先ディレクトリを指定可能（未指定時は既定パス）。
7. **今すぐ日報生成** ボタンで手動実行。

## データ保存先

Debug / Release ともに `App Sandbox` を無効化しているため、データはローカルに保存されます。日報保存先を未指定の場合は Application Support 配下、指定した場合はそのディレクトリ配下に `YYYY/MM/DD/report.md` で保存されます。

```
~/Library/Application Support/timeSlice/
├── data/YYYY/MM/DD/HHMMSS_xxxx.json    # OCR レコード（30日保持）
├── images/YYYY/MM/DD/HHMMSS_xxxx.png   # スクリーンショット（3日保持）
└── reports/YYYY/MM/DD/
    ├── report.md                        # 生成された日報（既定・最新）
    └── report-YYYY-MM-DD-HHmmss.md      # 再生成時のバックアップ（ファイル更新時刻ベース）
```

過去に Sandbox 有効版を利用していた場合、旧データは次のコンテナパスに残ります。

`~/Library/Containers/com.dmng.timeslice.timeSlice/Data/Library/Application Support/timeSlice/`

## 画面収録権限について
timeSlice は最前面ウィンドウのキャプチャに画面収録権限が必要です。初回起動時に許可を求めるダイアログが表示されますが、もし表示されない場合は以下の手順で手動で許可してください。
1. システム設定を開く
2. 「プライバシーとセキュリティ」 > 「画面収録」 に移動
3. timeSlice を見つけてチェックを入れる

## 注意事項 / トラブルシューティング

- GUI アプリとして起動すると PATH が制限されるため、CLI コマンドが見つからない場合があります。CLIExecutor は `/opt/homebrew/bin`、`/usr/local/bin`、`~/.local/bin` などを PATH に自動追加します。
- Release アーカイブではコード署名が必要です。`Signing & Capabilities` で Team/証明書を正しく設定し、`Hardened Runtime` を有効にしてビルドしてください。
- 画面収録権限ダイアログが出ない場合は、システム設定 > プライバシーとセキュリティ > 画面収録 で手動で許可してください。
