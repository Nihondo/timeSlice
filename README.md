# timeSlice

**In Development**

timeSlice は macOS Sonoma+ のメニューバーアプリです。最前面ウィンドウを定期キャプチャし、OCR でテキストを抽出、AIエージェント CLI を使って日報を自動生成します。OCRはローカルで実行され、外部サーバーへの送信は行いません。Dock には表示されず、操作はメニューバーから行います。

UI文言は `Localizable.strings` により多言語化されており、現在は日本語と英語に対応しています。

## ダウンロード
最新版はこちらからダウンロードしてください: [ダウンロード](https://github.com/Nihondo/timeSlice/releases/latest/download/timeSlice.zip)

## クイックスタート

1. timeSlice をビルドして起動する（[ビルド方法](#ソースからビルド)を参照）。
2. 初回起動時に **画面収録権限** の許可ダイアログが表示されるので許可する。
3. メニューバーの timeSlice アイコンから **記録開始** を選択する。
4. 日報を生成したい場合は **日報を生成** を選択する（CLI 設定が必要）。

## 出力サンプル
![](./images/timeSlice_sample.png)
出力内容はプロンプトで制御可能です。上記は以下のプロンプトで生成された例です。

```
以下は{{DATE}} ({{TIME_RANGE}}) の作業記録データです。
いまの作業ディレクトリは `timeSlice/data` です。
次のファイルを読み込んで、内容を要約して日報を作成してください:
{{JSON_FILE_LIST}}

期待レコード件数の目安: {{RECORD_COUNT}} 件

各 JSON の構造:
- `applicationName`: フロントアプリ名
- `windowTitle`: ウィンドウタイトル（null の場合あり）
- `capturedAt`: ISO 8601 の記録時刻
- `ocrText`: OCR結果テキスト
- `hasImage`: 画像保存フラグ
- `captureTrigger`: 記録トリガー（`manual` = 今すぐ記録、`scheduled` = 定期キャプチャ）

重要:
- 対象時間帯は {{TIME_RANGE}} です。`capturedAt` の時刻がこの範囲に含まれるレコードのみを対象にしてください。
- `captureTrigger` が `manual` の記録は、ユーザーが意図的に残した重要ログとして優先的に扱ってください。
- 概要・作業タイムライン・成果物/進捗には、`manual` の記録に基づく内容を必ず含めてください。

日報を Markdown で作成してください。次の構成を厳守してください:
1. 概要（2-3文）
2. 作業タイムライン（時間帯ごと）
3. 使用アプリケーション一覧と使用時間
4. 成果物・進捗
5. 所感（任意）
```

## メニューバー

メニューバーアイコンは記録状態に応じて変化します。

- 停止中: `record.circle`（白丸）/ タイトル「timeSlice」
- 記録中: `record.circle.fill`（赤丸）/ タイトル「timeSlice ●」

### メニュー項目

| 項目 | 説明 |
|------|------|
| **timeSlice 設定...** (⌘,) | 設定ウィンドウを開く |
| **記録開始** / **記録終了** | キャプチャの開始・停止を切り替え |
| **今すぐ記録** | 1回だけキャプチャを実行（`captureTrigger: "manual"` として保存）。完了時は結果とウィンドウタイトルを通知に表示 |
| **日報を生成** | 設定済みの AI CLI で日報を生成 |
| **終了** (⌘Q) | アプリを終了 |

## キャプチャの仕組み

1. 設定間隔（デフォルト 60 秒）ごとに最前面ウィンドウをキャプチャ
2. OCR除外アプリに一致する場合は、OCR と画像保存を行わずにアプリ名のみ記録（`ocrText: ""`, `hasImage: false`）
3. 除外対象外の場合は Vision Framework で OCR テキストを抽出
4. 直前の記録と重複する場合はスキップ（ハッシュベース重複排除）
5. JSON レコード + PNG 画像（任意）をローカルに保存（JSON には `captureTrigger` として `manual` / `scheduled` を記録）

## 日報生成

外部の AIエージェント CLI（`opencode`、`claude`、`gemini` など）にプロンプトを渡して日報を生成します。
opencodeなど、簡単にローカルLLMと連携できるCLIの利用を推奨します。

- 生成フローは以下の通りです。
- CLI は `data/` ディレクトリをカレントディレクトリとして実行される
- プロンプトで相対 glob パスを参照指示し、CLI が直接 JSON を読む方式
  - `{{JSON_GLOB_PATH}}`: glob パスを半角スペース連結した文字列
  - `{{JSON_FILE_LIST}}`: glob パスを改行連結した文字列
  - 跨ぎスロット（例: `18:00-25:00`）では、対象日と翌日ぶんの glob が展開される
- 既定プロンプトでは、`captureTrigger = manual` の記録を重要ログとして優先的に要約するよう指示される
- 全日モード: `reports/YYYY/MM/DD/report.md` に保存
- タイムスロットモード: 複数スロット有効時は `reports/YYYY/MM/DD/report-0800-1200.md` のように時刻ベースのファイル名で保存（有効スロットが1つだけの場合は `report.md`）
- 同日に再生成した場合は、上書き前の内容をファイル更新時刻ベースのバックアップとして保存
- `-p` / `--prompt` が末尾引数の場合、プロンプト文字列を自動的に引数値として注入
- 定時自動生成はタイムスロット専用モデル。各スロットの終了時刻に生成フローが実行される
- **タイムスロット機能**: 1日を複数の時間帯に分割し、各時間帯のレコードのみで日報を生成。`25:00` のような翌日跨ぎにも対応
- 日報生成完了時に通知センターへ通知され、通知クリックで `open` コマンドにより保存済みレポートファイルを開ける

## 設定ガイド

### 一般

1. **設定** を開く。
2. **画面収録** で権限状態を確認する。未許可の場合は「権限状態を更新」で再確認。
3. **キーボードショートカット** で「今すぐ記録」のショートカットを設定する。
   - ショートカット欄をクリック後、キー + 修飾キー（⌘ / ⌥ / ⇧ / ⌃）を押して確定
   - `Esc` で入力キャンセル、`Delete` でショートカット無効化
   - アプリ起動中は他アプリを操作中でもグローバルに実行可能
4. **起動** セクションで以下を設定する。
   - **アプリ起動と同時に記録を開始**: ON にするとアプリ起動時に自動で記録開始
   - **ログイン時起動**: macOS ログイン時にアプリを自動起動（`SMAppService` 連携）

### キャプチャ

1. **キャプチャ** タブを開く。
2. **キャプチャ間隔** をスライダーで調整（10〜600 秒、デフォルト 60 秒）。
3. **最小テキスト長** を設定（デフォルト 10 文字）。この文字数以下の短文は記録されない。
4. **OCR除外アプリ** にアプリ名を追加すると、そのアプリがフロントのときはOCRを実行せずアプリ名のみ記録。
5. **画像も保存する** トグルで PNG 保存の有無を切り替え。

### CLI

1. **CLI** タブを開く。
2. **CLI コマンド名** に AI CLI のコマンドを入力（例: `claude`、`gemini`）。
3. **追加引数** を設定（例: `-p`）。
4. **タイムアウト** を調整（30〜3600 秒、デフォルト 300 秒）。

### 日報

1. **日報** タブを開く。
2. **定時自動生成** を有効化し、タイムスロットを設定する。
   - 各スロットは **開始時刻・終了時刻・有効/無効** を編集可能。
   - 既定スロットは `08:00-25:00`（有効）と、`08:00-12:00` / `12:00-18:00` / `18:00-25:00`（無効）。
   - 終了時刻が `25:00` 以上のスロットは翌日に実行され、前日ぶんのレコードを対象に生成する。
3. **日報保存先** で保存先ディレクトリを指定可能（未指定時は既定パス）。
4. **対象日** を選んで「今すぐ日報生成」で手動実行できる。
5. 各タイムスロット行の ▶ ボタンで、そのスロットのみを手動生成できる。

### プロンプト

1. **プロンプト** タブを開く。
2. **プロンプトテンプレート** を編集。使用可能なプレースホルダ:
   - `{{DATE}}` — 対象日（例: 2026-02-16）
   - `{{TIME_RANGE}}` — 対象時間帯（例: "08:00-12:00"、全日時は "全日"）
   - `{{JSON_GLOB_PATH}}` — JSON glob パスの半角スペース連結
   - `{{JSON_FILE_LIST}}` — JSON glob パスの改行連結
   - `{{RECORD_COUNT}}` — 対象レコード数
3. 「デフォルトに戻す」で既定テンプレートにリセット可能。

## データ保存先

Debug / Release ともに `App Sandbox` を無効化しているため、データはローカルに保存されます。日報保存先を未指定の場合は Application Support 配下、指定した場合はそのディレクトリ配下に `YYYY/MM/DD/report.md` で保存されます。

```
~/Library/Application Support/timeSlice/
├── data/YYYY/MM/DD/HHMMSS_xxxx.json    # OCR レコード（30日保持）
├── images/YYYY/MM/DD/HHMMSS_xxxx.png   # スクリーンショット（3日保持）
└── reports/YYYY/MM/DD/
    ├── report.md                        # 全日レポート（既定・最新）
    ├── report-0800-1200.md              # タイムスロット別レポート（午前の例）
    ├── report-1200-1800.md              # タイムスロット別レポート（午後の例）
    ├── report-1800-2500.md              # タイムスロット別レポート（夜の例）
    └── report-YYYY-MM-DD-HHmmss.md      # 再生成時のバックアップ（ファイル更新時刻ベース）
```

過去に Sandbox 有効版を利用していた場合、旧データは次のコンテナパスに残ります。

`~/Library/Containers/com.dmng.timeslice.timeSlice/Data/Library/Application Support/timeSlice/`

## 画面収録権限について
timeSlice は最前面ウィンドウのキャプチャに画面収録権限が必要です。初回起動時に許可を求めるダイアログが表示されますが、もし表示されない場合は以下の手順で手動で許可してください。
1. システム設定を開く
2. 「プライバシーとセキュリティ」 > 「画面収録」 に移動
3. timeSlice を見つけてチェックを入れる

## ソースからビルド

Xcode プロジェクトのみ対応です（`swift build` / `swift run` は使用不可）。

```bash
# ビルド
xcodebuild -project timeSlice.xcodeproj -scheme timeSlice -configuration Debug -derivedDataPath ./.xcode-derived build

# 起動
open ./.xcode-derived/Build/Products/Debug/timeSlice.app
```

画面収録権限はアプリバンドル（`.app`）に紐づくため、ターミナルから直接実行せず `.app` として起動してください。

## 注意事項 / トラブルシューティング

- GUI アプリとして起動すると PATH が制限されるため、CLI コマンドが見つからない場合があります。CLIExecutor は `/opt/homebrew/bin`、`/usr/local/bin`、`~/.local/bin` などを PATH に自動追加します。
- Release アーカイブではコード署名が必要です。`Signing & Capabilities` で Team/証明書を正しく設定し、`Hardened Runtime` を有効にしてビルドしてください。
- 画面収録権限ダイアログが出ない場合は、システム設定 > プライバシーとセキュリティ > 画面収録 で手動で許可してください。
